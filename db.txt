USE [eSupport_Test]
GO

/****** Object:  Table [dbo].[tblUserCheck_1]    Script Date: 12/16/2019 9:11:39 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[tblUserCheck_1](
	[CountR] [int] NOT NULL,
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[version] [varchar](max) NULL,
	[TUser] [varchar](50) NULL,
	[uTimeStamp] [datetime] NULL,
	[Token] [bit] NULL,
	[TokenValue] [varchar](50) NULL,
	[Guidx] [uniqueidentifier] NULL,
	[AccessLevel] [varchar](10) NULL,
	[Admin] [bit] NULL,
	[AdminMessage] [varchar](max) NULL,
 CONSTRAINT [PK_tblUserCheck_1] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [dbo].[tblUserCheck_1] ADD  DEFAULT ((0)) FOR [Token]
GO

ALTER TABLE [dbo].[tblUserCheck_1] ADD  DEFAULT ('EVUNS') FOR [TokenValue]
GO

ALTER TABLE [dbo].[tblUserCheck_1] ADD  DEFAULT (NULL) FOR [Guidx]
GO

ALTER TABLE [dbo].[tblUserCheck_1] ADD  DEFAULT ((0)) FOR [AccessLevel]
GO




GO
/****** Object:  StoredProcedure [dbo].[GetHostEntries_2]    Script Date: 12/16/2019 7:58:44 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[GetHostEntries_2] 
(

	@User VARCHAR(99),
	@Tool Varchar(100) ,
	@Guid Varchar (max),
	@Admin bit =NULL
	
)
AS
BEGIN 
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

DECLARE @USERcOUNT INT
DECLARE @Body varchar(max)
DECLARE @mailto varchar(max)
DECLARE @subject varchar(max)
DECLARE @Acccontent1 varchar(max)
DECLARE @Acccontent2 varchar(max)
DECLARE @Acccontent3 varchar(max)
DECLARE @ADcccontent1 varchar(max)
DECLARE @ADcccontent2 varchar(max)
DECLARE @ADcccontent3 varchar(max)
DECLARE @ph1 varchar(max)
DECLARE @ph2 varchar(max)
Set @mailto='Sailaja.Chillale@Dell.com'
Set @subject='Get Host Entry Access.'
set @Body = 'Hi Admin, %0D%0A
Can you please give access for this tool.%0D%0A %0D%0A
User : #User#   %0D%0A
Guid: #Guid#   %0D%0A
Version: #Version#   %0D%0A
Tab: #Tab#  %0D%0A
Time: #Time#  %0D%0A
-------------------------------------------------------- %0D%0A' 
sET @Acccontent1 ='Dear user, 
Please contact the admin to get the access 
for this tool.'
sET @Acccontent2 =''
sET @ADcccontent1 ='Working in Progress'
SELECT distinct ID,EnvID,IP,[Site] FROM Host_Entries_1  order by Envid 
SET @USERcOUNT=(SELECT TOP 1 CountR from  tblUSerCheck_1 where TUser=@User) 	
		IF(@USERcOUNT IS null)
		BEGIN
			SET @USERcOUNT=1
		 END
		IF NOT EXISTS(select TOP 1 TUser from tblUSerCheck_1 where TUser = @User)
			BEGIN
			INSERT INTO tblUSerCheck_1 (TUser,uTimeStamp,CountR,version,Token,TokenValue,Guidx,AccessLevel,[Admin]) VALUES(upper(@User),GETDATE(),1,@Tool,0,'EVUNS',newid(),0,0)
			SELECT top 1 AccessLevel,Guidx,Tuser,uTimeStamp,TokenValue,@Body as Body,  @subject as subject, @mailto as mailto ,
			@Acccontent1 as Acccontent1 ,@Acccontent2 as Acccontent2 ,@Acccontent3 as Acccontent3,@ADcccontent1 as ADcccontent1,
			 @ADcccontent2  as ADcccontent2,@ADcccontent3  as ADcccontent3, @ph1 as ph1,@ph2 as ph2
			FROM tblUSerCheck_1 where Tuser=@User 
			RETURN 1
			END
				ELSE
				BEGIN
			UPDATE  tblUSerCheck_1  SET CountR = CountR+1 ,uTimeStamp= GETDATE(),version=@Tool WHERE TUser= @User 
			SELECT top 1 AccessLevel,Guidx,Tuser,uTimeStamp,TokenValue,@Body  as Body ,  @subject as subject, @mailto as mailto,
			@Acccontent1 as Acccontent1 ,@Acccontent2 as Acccontent2 ,@Acccontent3 as Acccontent3,@ADcccontent1 as ADcccontent1,
			 @ADcccontent2  as ADcccontent2,@ADcccontent3  as ADcccontent3, @ph1 as ph1,@ph2 as ph2 FROM tblUSerCheck_1 where Tuser=@User
			 RETURN 2
			 END
	END
	

	